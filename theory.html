<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Theory &amp; Practice &mdash; WecOptTool 2.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Implementation" href="implementation.html" />
    <link rel="prev" title="WecOptTool" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> WecOptTool
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Theory &amp; Practice</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#basic-concept">Basic concept</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-s-this-different-from-what-i-m-used-to">How’s this different from what I’m used to?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#practical-concerns">Practical concerns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#automatic-differentiation">Automatic differentiation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scaling">Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constraints">Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#buoyancy-gravity">Buoyancy/gravity</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pto-kinematics">PTO Kinematics</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="implementation.html">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api_docs.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">WecOptTool</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Theory &amp; Practice</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="theory-practice">
<h1>Theory &amp; Practice<a class="headerlink" href="#theory-practice" title="Permalink to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This theory section is intended to give a very high-level understanding of key concepts for WecOptTool.
For a more detailed explanation, please see <span id="id1">[<a class="reference internal" href="references.html#id2" title="Giorgio Bacelli. Optimal control of wave energy converters. PhD, National University of Ireland, Maynooth, Maynooth, Ireland, 2014. URL: http://mural.maynoothuniversity.ie/6753/.">1</a>, <a class="reference internal" href="references.html#id6" title="Giorgio Bacelli and John V Ringwood. Numerical optimal control of wave energy converters. IEEE Transactions on Sustainable Energy, 6(2):294–302, 2014. doi:10.1109/TSTE.2014.2371536.">2</a>, <a class="reference internal" href="references.html#id4" title="Ryan G. Coe, Giorgio Bacelli, Sterling Olson, Vincent S. Neary, and Mathew B. R. Topper. Initial conceptual demonstration of control co-design for WEC optimization. Journal of Ocean Engineering and Marine Energy, 6(4):441–449, 2020. doi:10.1007/s40722-020-00181-9.">3</a>]</span>.
A journal paper will be available soon.</p>
</div>
<section id="basic-concept">
<h2>Basic concept<a class="headerlink" href="#basic-concept" title="Permalink to this heading"></a></h2>
<p>WecOptTool uses a pseudo-spectral method <span id="id2">[<a class="reference internal" href="references.html#id3" title="G. Elnagar, M.A. Kazemi, and M. Razzaghi. The pseudospectral legendre method for discretizing optimal control problems. IEEE Transactions on Automatic Control, 40(10):1793-1796, 1995. doi:10.1109/9.467672.">4</a>]</span> to perform two tasks synchronously:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Optimize the solution for the desired objective function (e.g. power generation)</p></li>
<li><p>Simulate the wave energy converter (WEC) dynamics</p></li>
</ol>
</div></blockquote>
<p>This can be written as a traditional optimization problem:</p>
<div class="math notranslate nohighlight" id="equation-optim-prob">
<span class="eqno">(1)<a class="headerlink" href="#equation-optim-prob" title="Permalink to this equation"></a></span>\[\begin{split}\min\limits_x J(x) \\
\textrm{s.t.}&amp; \\
r(x) &amp;= 0 \\
c_{ineq}(x) &amp;\leq 0 \\
c_{eq}(x) &amp;= 0\end{split}\]</div>
<p>Here, <span class="math notranslate nohighlight">\(x\)</span> is the state vector which includes both the WEC dynamic state (<span class="math notranslate nohighlight">\(x_{w}\)</span>) and the user-defined control state to be optimized (<span class="math notranslate nohighlight">\(x_{u}\)</span>), as <span class="math notranslate nohighlight">\(x = [x_{w}, x_{u}]\)</span>.
We wish to find optimal values for <span class="math notranslate nohighlight">\(x_{u}\)</span> to minimize the objective function <span class="math notranslate nohighlight">\(J(x)\)</span>.
This accomplishes <em>task 1</em> from above.
The solution is forced to follow the dynamics of the system via the constraint <span class="math notranslate nohighlight">\(r(x) = 0\)</span>, where <span class="math notranslate nohighlight">\(r(x)\)</span> is the WEC dynamics equation in residual form.
This accomplishes <em>task 2</em> from above.
The dynamic residual includes the linear hydrodynamic forces from a BEM solution plus any number of arbitrary nonlinear forces such as power take-off (PTO) force, mooring forces, and non-linear hydrodynamic forces.
Additionally, any number of arbitrary nonlinear constraints, such as requiring a tether to remain in tension or limiting the maximum force exerted by the PTO, can be included in <span class="math notranslate nohighlight">\(c_{ineq}(x)\)</span> and <span class="math notranslate nohighlight">\(c_{eq}(x)\)</span>.</p>
<p>Solving <a class="reference internal" href="#equation-optim-prob">(1)</a>, we can find the optimal control state <span class="math notranslate nohighlight">\(x_{u}\)</span> (e.g., PTO force) that minimizes our objective function (e.g., power generation) for a given WEC design subject to arbitrary constraints and including nonlinear dynamics.
The pseudo-spectral method has a number of key attributes that make it well-suited to this application:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>Explicit constraints:</strong> Dynamic and kinematic constraints can be enforced explicitly, negating the need to run unfeasible solutions and thus reducing computational cost.</p></li>
<li><p><strong>Efficient simulation of nonlinear dynamics:</strong> Frequency-domain solutions cannot include nonlinear dynamics and time-domain solutions can only do so with significant computational cost; the pseudo-spectral method can efficiently handle nonlinear systems.</p></li>
<li><p><strong>Arbitrary or fixed controller structure:</strong> As a starting point, one may consider optimal control without a given structure. Later on, it may be useful to consider, e.g., a proportional feedback or latching controller. This can be accomplished via the pseudo-spectral method by structuring the system dynamics and the control vector (<span class="math notranslate nohighlight">\(x_{u}\)</span>).</p></li>
</ul>
</div></blockquote>
<p>The solution to <a class="reference internal" href="#equation-optim-prob">(1)</a> can be wrapped with an <em>outer</em> design optimization problem, in which any optimization algorithm can be applied.
Some examples of problems which can be addressed within this framework include:</p>
<blockquote>
<div><ul class="simple">
<li><p>Optimization of geometry dimensions for a hull</p></li>
<li><p>Optimization of PTO components (e.g., inertia of a flywheel, a gear ratio)</p></li>
<li><p>Optimization of ballast versus pre-tension</p></li>
<li><p>Optimization of the layout for a WEC array</p></li>
</ul>
</div></blockquote>
</section>
<section id="how-s-this-different-from-what-i-m-used-to">
<h2>How’s this different from what I’m used to?<a class="headerlink" href="#how-s-this-different-from-what-i-m-used-to" title="Permalink to this heading"></a></h2>
<p>Most users will be more familiar with a time-stepping approach for differential equations–this is the method applied in Simulink and therefore <a class="reference external" href="https://wec-sim.github.io/WEC-Sim/master/index.html">WEC-Sim</a>.
Starting from an initial time (e.g., <span class="math notranslate nohighlight">\(t=0\)</span>), the solution is solved by iteratively stepping forward in time.</p>
<a class="reference internal image-reference" href="_images/theory_animation_td.gif"><img alt="Time-domain solution animation" class="align-center" src="_images/theory_animation_td.gif" style="width: 600px;" /></a>
<p>Pseudo-spectral methods can be applied to solve the same differential equations, but solve the entire time period of interest at once.
At first the solution will not be correct, but as the optimization algorithm iterates, it will progressively improve the solution.</p>
<a class="reference internal image-reference" href="_images/theory_animation_ps.gif"><img alt="Pseudo-spectral solution animation" class="align-center" src="_images/theory_animation_ps.gif" style="width: 600px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These animations are simplifications and do not fully capture all details of either the time-stepping or pseudo-spectral numerical optimization solution.</p>
</div>
</section>
<section id="practical-concerns">
<h2>Practical concerns<a class="headerlink" href="#practical-concerns" title="Permalink to this heading"></a></h2>
<section id="automatic-differentiation">
<h3>Automatic differentiation<a class="headerlink" href="#automatic-differentiation" title="Permalink to this heading"></a></h3>
<p>In practice, the size of the decision vector <span class="math notranslate nohighlight">\(x\)</span> from <a class="reference internal" href="#equation-optim-prob">(1)</a> will often be quite large.
For a single degree of freedom device, <span class="math notranslate nohighlight">\(x\)</span> can easily be <span class="math notranslate nohighlight">\(\mathcal{O}(1e2)\)</span>.
To obtain high accuracy solutions to optimization problems with large numbers of decision variables, without requiring users to provide analytic gradients (i.e., the Jacobian and Hessian matrices), WecOptTool employs the <a class="reference external" href="https://en.wikipedia.org/wiki/Automatic_differentiation">automatic differentiation</a> package <a class="reference external" href="https://github.com/HIPS/autograd">Autograd</a>.
In practice, most WecOptTool users should only need to know that when writing custom functions to define their device, they should simply use the <a class="reference external" href="https://github.com/HIPS/autograd">Autograd</a> replacement for <a class="reference external" href="https://numpy.org">NumPy</a> by calling <code class="code docutils literal notranslate"><span class="pre">import</span> <span class="pre">autograd.numpy</span> <span class="pre">as</span> <span class="pre">np</span></code>.
Note that <a class="reference external" href="https://github.com/HIPS/autograd">Autograd</a> does not support all of <a class="reference external" href="https://numpy.org">NumPy</a> (see the <a class="reference external" href="https://github.com/HIPS/autograd/blob/master/docs/tutorial.md#supported-and-unsupported-parts-of-numpyscipy">Autograd documentation</a>) and using unsupported parts can result in silent failure of the automatic differentiation.</p>
</section>
<section id="scaling">
<h3>Scaling<a class="headerlink" href="#scaling" title="Permalink to this heading"></a></h3>
<p>For many WEC problems, <a class="reference internal" href="#equation-optim-prob">(1)</a> will be poorly scaled.
Recall that <span class="math notranslate nohighlight">\(x = [x_{w}, x_{u}]\)</span>, where <span class="math notranslate nohighlight">\(x_{w}\)</span> describes the state of the WEC (e.g., velocities) and <span class="math notranslate nohighlight">\(x_{u}\)</span> is a vector to be optimized to maximize power absorption.
Consider, for example, a general case without a controller structure, in which <span class="math notranslate nohighlight">\(x_{u}\)</span> would relate to PTO forces.
For a wave tank scale device, one might expect velocities of <span class="math notranslate nohighlight">\(\mathcal{O}(1e{-1})\)</span>, but the forces could be <span class="math notranslate nohighlight">\(\mathcal{O}(1e3)\)</span>.
For larger WECs, this discrepancy in the orders of magnitude may be even worse.
Scaling mismatches in the decision variable <span class="math notranslate nohighlight">\(x\)</span> and with the objective function <span class="math notranslate nohighlight">\(J(x)\)</span> can lead to problems with convergence.
To alleviate this issue, WecOptTool allows users to set scale factors for the components of <span class="math notranslate nohighlight">\(x\)</span> as well as the objective function (see <a class="reference internal" href="api_docs/wecopttool.core.WEC.solve.html#wecopttool.core.WEC.solve" title="wecopttool.core.WEC.solve"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wecopttool.core.WEC.solve()</span></code></a>).
Additionally, you may set <code class="code docutils literal notranslate"><span class="pre">import</span> <span class="pre">logging,</span> <span class="pre">logging.basicConfig(level=logging.INFO)</span></code> to output the maximum values of <cite>x</cite> and the objective function during the solution process.
Depending on your problem, it may also be helpful to use the <code class="xref py py-meth docutils literal notranslate"><span class="pre">wecopttool.core.WEC.initial_x_wec_guess()</span></code> method and/or the <code class="code docutils literal notranslate"><span class="pre">unconstrained_first</span></code> for <a class="reference internal" href="api_docs/wecopttool.core.WEC.solve.html#wecopttool.core.WEC.solve" title="wecopttool.core.WEC.solve"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wecopttool.core.WEC.solve()</span></code></a>.</p>
</section>
<section id="constraints">
<h3>Constraints<a class="headerlink" href="#constraints" title="Permalink to this heading"></a></h3>
<p>Constraints, such as maximum PTO force, maximum piston force, or maintaining tension in a tether, may be enforced in WecOptTool.</p>
<p>An important practical factor when using this functionality is to make sure that the constraint is evaluated at a sufficient number of collocation points.
It may be required to enforce constraints at more points than the dynamics (as defined by the frequency array).
In WecOptTool’s example PTO module, this is controlled by the <code class="code docutils literal notranslate"><span class="pre">nsubsteps</span></code> argument (see, e.g., <a class="reference internal" href="api_docs/wecopttool.pto.PTO.force_on_wec.html#wecopttool.pto.PTO.force_on_wec" title="wecopttool.pto.PTO.force_on_wec"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wecopttool.pto.PTO.force_on_wec()</span></code></a>).</p>
</section>
<section id="buoyancy-gravity">
<h3>Buoyancy/gravity<a class="headerlink" href="#buoyancy-gravity" title="Permalink to this heading"></a></h3>
<p>As WecOptTool is intended primarily to utilize linear potential flow hydrodynamics, a linear hydrostatic stiffness is used.
The implicit assumption of this approach is that the body is neutrally buoyant (i.e., gravitational and buoyancy forces are in balance at the zero position).
However, some WECs achieve equilibrium through a pretension applied via mooring and/or the PTO.
In this case, the device can still be modeled with the linear hydrostatic stiffness, but if you wish to solve for the pretension force in your simulations, you may explicitly include the buoyancy, gravity, and pretension forces via the <code class="code docutils literal notranslate"><span class="pre">f_add</span></code> argument to <a class="reference internal" href="api_docs/wecopttool.core.WEC.html#wecopttool.core.WEC" title="wecopttool.core.WEC"><code class="xref py py-class docutils literal notranslate"><span class="pre">wecopttool.core.WEC</span></code></a>.</p>
</section>
<section id="pto-kinematics">
<h3>PTO Kinematics<a class="headerlink" href="#pto-kinematics" title="Permalink to this heading"></a></h3>
<p>The <a class="reference internal" href="api_docs/wecopttool.pto.html#module-wecopttool.pto" title="wecopttool.pto"><code class="xref py py-mod docutils literal notranslate"><span class="pre">wecopttool.pto</span></code></a> module includes several examples of PTOs that can be used for both additional PTO forces on the WEC dynamics and for objective functions (e.g., PTO average power).
Creating one of these pre-defined PTOs requires specifying the <em>kinematics matrix</em>.
Here, the kinematics matrix, <span class="math notranslate nohighlight">\(K\)</span>, is defined as the linear transformation from the WEC position (e.g., heave) in the global frame, <span class="math notranslate nohighlight">\(x\)</span>, to the PTO position in the PTO frame (e.g., tether length/generator rotation), <span class="math notranslate nohighlight">\(p\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-kinematics">
<span class="eqno">(2)<a class="headerlink" href="#equation-kinematics" title="Permalink to this equation"></a></span>\[p = K x\]</div>
<p>The relationship <span class="math notranslate nohighlight">\(p(x)\)</span> is typically referred to as the <em>forward kinematics</em>.
The matrix <span class="math notranslate nohighlight">\(K\)</span> has a size equal to the number of DOFs of the PTOs times the number of DOFs of the WEC.
Note, however that the real kinematics might not be linear.
Equation <a class="reference internal" href="#equation-kinematics">(2)</a> represents a linearization of <span class="math notranslate nohighlight">\(p(x)\)</span> about the mean <span class="math notranslate nohighlight">\(x=0\)</span> position, with the matrix <span class="math notranslate nohighlight">\(K\)</span> being the Jacobian of <span class="math notranslate nohighlight">\(p(x)\)</span> at <span class="math notranslate nohighlight">\(x=0\)</span>.</p>
<p>The transpose of <span class="math notranslate nohighlight">\(K\)</span> is used to transform the PTO forces in PTO frame, <span class="math notranslate nohighlight">\(f_p\)</span>, to the PTO forces on the WEC, <span class="math notranslate nohighlight">\(f_w\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-k">
<span class="eqno">(3)<a class="headerlink" href="#equation-k" title="Permalink to this equation"></a></span>\[f_w = K^T f_p\]</div>
<p>This relationship can be derived from conservation of energy in both frames, and using the definition in Equation <a class="reference internal" href="#equation-kinematics">(2)</a>:</p>
<div class="math notranslate nohighlight" id="equation-conservation-energy">
<span class="eqno">(4)<a class="headerlink" href="#equation-conservation-energy" title="Permalink to this equation"></a></span>\[\begin{split}f_w^T x = f_p^T p \\
f_w^T x = f_p^T K x \\
f_w^T = f_p^T K \\
f_w = K^T f_p \\\end{split}\]</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="WecOptTool" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="implementation.html" class="btn btn-neutral float-right" title="Implementation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright 2020 National Technology &amp; Engineering Solutions of Sandia, LLC(NTESS).Under the terms of Contract DE-NA0003525 with NTESS, the U.S. Government retains certain rights in this software..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>